name: secret-scan

on:
  pull_request:
  schedule:
    - cron: "17 8 * * *"
  workflow_dispatch:

jobs:
  gitleaks-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Install gitleaks
        run: |
          mkdir -p .tools
          GOBIN="$PWD/.tools" go install github.com/zricethezav/gitleaks/v8@v8.24.2
      - name: Scan pull request commits
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          ./.tools/gitleaks git \
            --no-banner \
            --redact \
            --log-opts="${BASE_SHA}..${HEAD_SHA}" \
            --report-format=json \
            --report-path=gitleaks-report-pr.json \
            .
      - name: Upload PR report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report-pr
          path: gitleaks-report-pr.json
          if-no-files-found: ignore

  gitleaks-full-history:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Install gitleaks
        run: |
          mkdir -p .tools
          GOBIN="$PWD/.tools" go install github.com/zricethezav/gitleaks/v8@v8.24.2
      - name: Scan full git history
        run: |
          ./.tools/gitleaks git \
            --no-banner \
            --redact \
            --report-format=json \
            --report-path=gitleaks-report-full.json \
            .
      - name: Upload full-history report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report-full
          path: gitleaks-report-full.json
          if-no-files-found: ignore
